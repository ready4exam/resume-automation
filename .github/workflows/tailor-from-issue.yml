name: Tailor Resume from Issue

on:
  issues:
    types: [opened]

permissions:
  contents: write
  issues: write

jobs:
  tailor:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install dependencies
        run: npm install

      - name: Parse issue body
        id: parse
        uses: actions/github-script@v7
        with:
          script: |
            const body = context.payload.issue.body || "";

            function extractSingle(label) {
              const re = new RegExp(`^${label}: *(.*)$`, "mi");
              const m = body.match(re);
              return m ? m[1].trim() : "";
            }

            const company = extractSingle("Company");
            const jobTitle = extractSingle("Job Title");
            const extra = extractSingle("Extra");
            const resumeMode = extractSingle("Resume Mode");       // infra | hybrid | dev
            const methods = extractSingle("Methodologies");        // e.g. "Agile,FinOps"

            // Everything after "Job Description:" is the JD
            const marker = "Job Description:";
            let jd = "";
            const idx = body.indexOf(marker);
            if (idx !== -1) {
              jd = body.substring(idx + marker.length).trim();
            }

            core.setOutput("company", company || "Unknown Company");
            core.setOutput("job_title", jobTitle || "Unknown Role");
            core.setOutput("extra", extra || "");
            core.setOutput("job_description", jd || "");
            core.setOutput("resume_mode", resumeMode || "infra");
            core.setOutput("methods", methods || "");

      - name: Save JD to file
        run: |
          mkdir -p tmp
          cat << 'EOF' > tmp/jd.txt
          ${{ steps.parse.outputs.job_description }}
          EOF

      - name: Run tailoring script (Phase 1)
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          node tailor_resume.mjs \
            --company "${{ steps.parse.outputs.company }}" \
            --job-title "${{ steps.parse.outputs.job_title }}" \
            --job-desc-file tmp/jd.txt \
            --extra "${{ steps.parse.outputs.extra }}" \
            --resume-mode "${{ steps.parse.outputs.resume_mode }}" \
            --methods "${{ steps.parse.outputs.methods }}"

      # ðŸ”¹ NEW: Phase 2 â€“ refine the resume using refine_resume.mjs,
      #         and keep output INSIDE the same jobs/<...> folder.
      - name: Run refine script (Phase 2 â€“ review & improve)
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          # Find the most recently modified job folder under jobs/
          LATEST_JOB_DIR=$(ls -td jobs/* | head -n 1)

          echo "Detected latest job folder: $LATEST_JOB_DIR"

          # Run Phase-2 refinement
          node refine_resume.mjs \
            --job-desc-file tmp/jd.txt \
            --raw-file "$LATEST_JOB_DIR/raw.txt" \
            --out-dir "$LATEST_JOB_DIR/phase2"

          echo "Phase-2 output stored in: $LATEST_JOB_DIR/phase2"

      - name: Commit generated resumes into repo
        run: |
          echo "Git status before commit:"
          git status

          git config user.name "github-actions"
          git config user.email "github-actions@github.com"

          git add jobs/ || echo "Nothing to add in jobs/"
          git commit -m "Add tailored + refined resume for issue #${{ github.event.issue.number }}" || echo "Nothing to commit"
          git push || echo "Nothing to push or push failed"

      - name: Comment back on issue with link to run
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const issue_number = context.payload.issue.number;
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const runId = process.env.GITHUB_RUN_ID;
            const url = `https://github.com/${owner}/${repo}/actions/runs/${runId}`;

            const body = [
              "âœ… Your tailored resume *and* refined resume (reviewed + improved) have been generated.",
              "",
              "ðŸ—‚ Files have been committed under the `jobs/` folder in this repo.",
              "",
              "- Phase 1: raw + DOCX in the job folder",
              "- Phase 2: review + refined resume under `phase2/` inside that job folder",
              "",
              `ðŸ”— Actions run: ${url}`
            ].join("\n");

            await github.rest.issues.createComment({
              owner
