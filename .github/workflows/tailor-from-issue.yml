name: Tailor Resume from Issue

on:
  issues:
    types: [opened]

# Needed so the workflow can:
# - write comments on issues
# - commit the jobs/ folder back to the repo
permissions:
  contents: write
  issues: write

jobs:
  tailor:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # required so we can commit and push

      - name: Set up Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install dependencies
        run: npm install

      - name: Parse issue body
        id: parse
        uses: actions/github-script@v7
        with:
          script: |
            const body = context.payload.issue.body || "";

            function extractSingle(label) {
              const re = new RegExp(`^${label}: *(.*)$`, "mi");
              const m = body.match(re);
              return m ? m[1].trim() : "";
            }

            const company = extractSingle("Company");
            const jobTitle = extractSingle("Job Title");
            const extra = extractSingle("Extra");

            // Everything after "Job Description:" is the JD
            const marker = "Job Description:";
            let jd = "";
            const idx = body.indexOf(marker);
            if (idx !== -1) {
              jd = body.substring(idx + marker.length).trim();
            }

            core.setOutput("company", company || "Unknown Company");
            core.setOutput("job_title", jobTitle || "Unknown Role");
            core.setOutput("extra", extra || "");
            core.setOutput("job_description", jd || "");

      - name: Save JD to file
        run: |
          mkdir -p tmp
          cat << 'EOF' > tmp/jd.txt
          ${{ steps.parse.outputs.job_description }}
          EOF

      - name: Run tailoring script
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          # You can later extend this to pass --resume-mode and --methods
          node tailor_resume.mjs \
            --company "${{ steps.parse.outputs.company }}" \
            --job-title "${{ steps.parse.outputs.job_title }}" \
            --job-desc-file tmp/jd.txt \
            --extra "${{ steps.parse.outputs.extra }}"

      - name: Upload tailored resume artifacts
        uses: actions/upload-artifact@v4
        with:
          name: "tailored-resume-${{ github.event.issue.number }}"
          path: jobs/

      - name: Commit generated resumes into repo
        run: |
          # Show what changed (for debugging)
          echo "Git status before commit:"
          git status

          # Configure bot identity
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"

          # Stage jobs/ changes (if any)
          git add jobs/ || echo "Nothing to add in jobs/"

          # Commit, but don't fail if there is nothing new
          git commit -m "Add tailored resume for issue #${{ github.event.issue.number }}" || echo "Nothing to commit"

          # Push back to the same branch this workflow ran on
          git push || echo "Nothing to push or push failed"

      - name: Comment back on issue with link to run
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const issue_number = context.payload.issue.number;
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const runId = process.env.GITHUB_RUN_ID;
            const url = `https://github.com/${owner}/${repo}/actions/runs/${runId}`;

            const body = [
              "âœ… Your tailored resume has been generated.",
              "",
              `ðŸ”— Actions run (download artifacts here): ${url}`,
              "",
              `ðŸ—‚ Resumes have also been committed under the jobs/ folder in this repo.`,
              "",
              `Look for the artifact named: tailored-resume-${issue_number}`
            ].join("\n");

            await github.rest.issues.createComment({
              owner,
              repo,
              issue_number,
              body
            });
