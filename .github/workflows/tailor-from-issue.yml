name: Tailor Resume from Issue

on:
  issues:
    types: [opened]

permissions:
  contents: write
  issues: write

jobs:
  tailor:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set up Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install dependencies
        run: npm install

      - name: Parse issue
        id: parse
        uses: actions/github-script@v7
        with:
          script: |
            const body = context.payload.issue.body || "";

            function extract(label) {
              const re = new RegExp(`^${label}: *(.*)$`, "mi");
              const m = body.match(re);
              return m ? m[1].trim() : "";
            }

            const company = extract("Company");
            const role = extract("Job Title");
            const extra = extract("Extra");
            const resumeMode = extract("Resume Mode");
            const methods = extract("Methodologies");

            const jdMark = "Job Description:";
            const idx = body.indexOf(jdMark);
            const jd = idx >= 0 ? body.substring(idx + jdMark.length).trim() : "";

            core.setOutput("company", company);
            core.setOutput("role", role);
            core.setOutput("extra", extra);
            core.setOutput("resume_mode", resumeMode);
            core.setOutput("methods", methods);
            core.setOutput("jd", jd);

      - name: Save JD to file
        run: |
          mkdir -p tmp
          echo "${{ steps.parse.outputs.jd }}" > tmp/jd.txt

      - name: Phase-1 (tailor)
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          node tailor_resume.mjs \
            --company "${{ steps.parse.outputs.company }}" \
            --job-title "${{ steps.parse.outputs.role }}" \
            --job-desc-file tmp/jd.txt \
            --extra "${{ steps.parse.outputs.extra }}" \
            --resume-mode "${{ steps.parse.outputs.resume_mode }}" \
            --methods "${{ steps.parse.outputs.methods }}"

      - name: Find latest job folder
        id: find
        run: |
          LATEST=$(ls -td jobs/*/*/* | head -n 1)
          echo "folder=$LATEST" >> $GITHUB_OUTPUT

      - name: Phase-2 (refine)
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          FOLDER="${{ steps.find.outputs.folder }}"
          node refine_resume.mjs \
            --job-desc-file tmp/jd.txt \
            --raw-file "$FOLDER/raw.txt" \
            --out-dir "$FOLDER/phase2"

      - name: Commit results
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git add jobs/
          git commit -m "Add tailored + refined resume" || true
          git push || true

      - name: Comment back
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const runId = process.env.GITHUB_RUN_ID;
            const url = `https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${runId}`;
            github.rest.issues.createComment({
              ...context.repo,
              issue_number: context.issue.number,
              body: `Your tailored + refined resume is ready.\n\nView run: ${url}`
            });
