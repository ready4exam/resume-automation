name: Tailor Resume from Issue

on:
  issues:
    types: [opened]

permissions:
  contents: write
  issues: write

jobs:
  tailor:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install dependencies
        run: npm install

      - name: Parse issue body
        id: parse
        uses: actions/github-script@v7
        with:
          script: |
            const body = context.payload.issue.body || "";

            function extractSingle(label) {
              const re = new RegExp(`^${label}: *(.*)$`, "mi");
              const m = body.match(re);
              return m ? m[1].trim() : "";
            }

            const company = extractSingle("Company");
            const jobTitle = extractSingle("Job Title");
            const extra = extractSingle("Extra");
            const resumeMode = extractSingle("Resume Mode");       // infra | hybrid | dev
            const methods = extractSingle("Methodologies");        // e.g. "Agile,FinOps"

            // Everything after "Job Description:" is JD
            const marker = "Job Description:";
            let jd = "";
            const idx = body.indexOf(marker);
            if (idx !== -1) jd = body.substring(idx + marker.length).trim();

            core.setOutput("company", company || "Unknown Company");
            core.setOutput("job_title", jobTitle || "Unknown Role");
            core.setOutput("extra", extra || "");
            core.setOutput("job_description", jd || "");
            core.setOutput("resume_mode", resumeMode || "infra");
            core.setOutput("methods", methods || "");

      - name: Save JD to file
        run: |
          mkdir -p tmp
          cat << 'EOF' > tmp/jd.txt
          ${{ steps.parse.outputs.job_description }}
          EOF

      - name: Run tailoring script (Phase 1)
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          node tailor_resume.mjs \
            --company "${{ steps.parse.outputs.company }}" \
            --job-title "${{ steps.parse.outputs.job_title }}" \
            --job-desc-file tmp/jd.txt \
            --extra "${{ steps.parse.outputs.extra }}" \
            --resume-mode "${{ steps.parse.outputs.resume_mode }}" \
            --methods "${{ steps.parse.outputs.methods }}"

      - name: Debug ‚Äî show jobs folder structure
        run: |
          echo "Jobs folder structure:"
          find jobs -maxdepth 3 -type d || true

      - name: Run refine script (Phase 2 ‚Äì review & improve)
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          # Detect deepest timestamped folder: jobs/*/*/*
          LATEST_JOB_DIR=$(ls -td jobs/*/*/* 2>/dev/null | head -n 1)

          echo "Detected latest job folder: $LATEST_JOB_DIR"

          if [ -z "$LATEST_JOB_DIR" ]; then
            echo "‚ùå ERROR: No job folder found in jobs/*/*/*"
            exit 1
          fi

          node refine_resume.mjs \
            --job-desc-file tmp/jd.txt \
            --raw-file "$LATEST_JOB_DIR/raw.txt" \
            --out-dir "$LATEST_JOB_DIR/phase2"

          echo "Phase-2 output stored in: $LATEST_JOB_DIR/phase2"

      - name: Commit generated resumes into repo
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"

          git add jobs/ || echo "Nothing to add"
          git commit -m "Add tailored + refined resume for issue #${{ github.event.issue.number }}" || echo "Nothing to commit"
          git push || echo "Push skipped"

      - name: Comment back on issue with link to run
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const issue_number = context.payload.issue.number;
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const runId = process.env.GITHUB_RUN_ID;

            const url = `https://github.com/${owner}/${repo}/actions/runs/${runId}`;

            const body = [
              "‚úÖ Your tailored resume *and* refined recruiter-reviewed resume have been generated.",
              "",
              "üìÇ Output stored under the `jobs/` folder in the repository:",
              "- Phase 1 ‚Üí raw.txt",
              "- Phase 2 ‚Üí refined_raw.txt + refined_resume.docx",
              "",
              `üîó View workflow run: ${url}`
            ].join("\n");

            await github.rest.issues.createComment({
              owner,
              repo,
              issue_number,
              body
            });
